import React, { useState } from 'react'
import { motion } from 'framer-motion'
import { AlertTriangle, ChevronDown, ChevronRight, Shield, ExternalLink } from 'lucide-react'
import { StatusBadge } from '../shared/StatusBadge'
import { useProtectionTheme } from '../../hooks/useProtectionTheme'

const SEVERITY_ORDER = { critical: 0, high: 1, medium: 2, low: 3 }

function FindingRow({ finding }) {
  const [expanded, setExpanded] = useState(false)

  const borderColor = {
    critical: 'border-red-500/30',
    high: 'border-orange-500/30',
    medium: 'border-yellow-500/30',
    low: 'border-blue-500/30',
  }[finding.severity] || 'border-white/10'

  const cvssColor = finding.cvss >= 9 ? 'text-red-400' : finding.cvss >= 7 ? 'text-orange-400' : finding.cvss >= 5 ? 'text-yellow-400' : 'text-blue-400'

  return (
    <div className={`rounded-lg border ${borderColor} bg-black/20 overflow-hidden`}>
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full flex items-start gap-3 p-3 text-left hover:bg-white/[0.03] transition-colors"
      >
        <StatusBadge status={finding.severity} className="flex-shrink-0 mt-0.5" />
        <div className="flex-1 min-w-0">
          <div className="text-xs font-semibold text-slate-200 truncate">{finding.title}</div>
          <div className="flex items-center gap-2 mt-0.5">
            <span className="text-[10px] font-mono text-slate-500">{finding.id}</span>
            <span className="text-[10px] text-slate-600">·</span>
            <span className="text-[10px] text-slate-500">{finding.category}</span>
          </div>
        </div>
        <div className="flex items-center gap-2 flex-shrink-0">
          <span className={`text-sm font-bold font-mono ${cvssColor}`}>{finding.cvss}</span>
          {expanded ? (
            <ChevronDown size={12} className="text-slate-500" />
          ) : (
            <ChevronRight size={12} className="text-slate-500" />
          )}
        </div>
      </button>

      {expanded && (
        <motion.div
          initial={{ height: 0, opacity: 0 }}
          animate={{ height: 'auto', opacity: 1 }}
          transition={{ duration: 0.15 }}
          className="px-3 pb-3 space-y-2 border-t border-white/10"
        >
          <div className="pt-2">
            <div className="text-[10px] text-slate-500 mb-1">Description</div>
            <p className="text-xs text-slate-300 leading-relaxed">{finding.description}</p>
          </div>
          <div>
            <div className="text-[10px] text-slate-500 mb-1">Remediation</div>
            <div className="flex items-start gap-2 p-2 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
              <Shield size={10} className="text-emerald-400 flex-shrink-0 mt-0.5" />
              <p className="text-xs text-emerald-300 leading-relaxed">{finding.remediation}</p>
            </div>
          </div>
          <div className="flex items-center gap-3 text-[10px] text-slate-600">
            <span>{finding.cwe}</span>
            <span>·</span>
            <span>CVSS {finding.cvss}</span>
          </div>
        </motion.div>
      )}
    </div>
  )
}

export function VulnerabilityReport({ findings, model }) {
  const theme = useProtectionTheme()

  if (!findings || findings.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-32 text-center">
        <Shield size={24} className="text-emerald-400 mb-2" />
        <p className="text-xs text-emerald-400 font-semibold">No findings detected</p>
        <p className="text-[10px] text-slate-600 mt-1">Model passed all security checks</p>
      </div>
    )
  }

  const sorted = [...findings].sort(
    (a, b) => (SEVERITY_ORDER[a.severity] ?? 9) - (SEVERITY_ORDER[b.severity] ?? 9)
  )

  const counts = findings.reduce((acc, f) => {
    acc[f.severity] = (acc[f.severity] || 0) + 1
    return acc
  }, {})

  return (
    <div className="space-y-3">
      {/* Summary */}
      <div className="grid grid-cols-4 gap-2">
        {['critical', 'high', 'medium', 'low'].map(sev => (
          <div
            key={sev}
            className={`text-center p-2 rounded-lg border ${
              sev === 'critical' ? 'bg-red-500/10 border-red-500/25' :
              sev === 'high' ? 'bg-orange-500/10 border-orange-500/25' :
              sev === 'medium' ? 'bg-yellow-500/10 border-yellow-500/25' :
              'bg-blue-500/10 border-blue-500/25'
            }`}
          >
            <div className={`text-lg font-bold font-mono ${
              sev === 'critical' ? 'text-red-400' :
              sev === 'high' ? 'text-orange-400' :
              sev === 'medium' ? 'text-yellow-400' :
              'text-blue-400'
            }`}>
              {counts[sev] || 0}
            </div>
            <div className="text-[9px] text-slate-600 uppercase">{sev}</div>
          </div>
        ))}
      </div>

      {/* Findings list */}
      <div className="space-y-2">
        {sorted.map((finding, i) => (
          <motion.div
            key={finding.id}
            initial={{ opacity: 0, y: 8 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: i * 0.06 }}
          >
            <FindingRow finding={finding} />
          </motion.div>
        ))}
      </div>
    </div>
  )
}
